name: Release Binaries

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for release (e.g., v1.0.0)'
        required: true
        type: string

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  BINARY_NAME: c-sharp-analyzer-provider-cli
  RUST_BACKTRACE: 1

jobs:
  # Build binaries for Linux targets using cross
  build-linux:
    name: Build Linux ${{ matrix.target }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            arch: x86_64
            os: linux
          - target: aarch64-unknown-linux-gnu
            arch: aarch64
            os: linux
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        run: |
          cargo install cross --git https://github.com/cross-rs/cross

      - name: Install Protoc
        uses: arduino/setup-protoc@v3

      - name: Download proto file
        run: |
          mkdir -p src/build/proto
          curl -L -o src/build/proto/provider.proto \
            https://raw.githubusercontent.com/konveyor/analyzer-lsp/refs/heads/main/provider/internal/grpc/library.proto

      - name: Cache cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build with cross
        run: |
          export PROTOC=$(which protoc)
          cross build --release --target ${{ matrix.target }}

      - name: Strip binary
        run: |
          if [[ "${{ matrix.target }}" == *"musl"* ]]; then
            echo "Skipping strip for musl target"
          else
            cross run --target ${{ matrix.target }} -- strip target/${{ matrix.target }}/release/${{ env.BINARY_NAME }} || true
          fi

      - name: Create archive
        run: |
          cd target/${{ matrix.target }}/release
          tar czf ../../../c-sharp-analyzer-provider-${{ matrix.os }}-${{ matrix.arch }}.tar.gz ${{ env.BINARY_NAME }}
          cd ../../../
          sha256sum c-sharp-analyzer-provider-${{ matrix.os }}-${{ matrix.arch }}.tar.gz > c-sharp-analyzer-provider-${{ matrix.os }}-${{ matrix.arch }}.tar.gz.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: c-sharp-analyzer-provider-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            c-sharp-analyzer-provider-${{ matrix.os }}-${{ matrix.arch }}.tar.gz
            c-sharp-analyzer-provider-${{ matrix.os }}-${{ matrix.arch }}.tar.gz.sha256

  # Build binaries for macOS targets
  build-macos:
    name: Build macOS ${{ matrix.target }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - target: x86_64-apple-darwin
            arch: x86_64
            os: darwin
            runner: macos-13  # Intel runner
          - target: aarch64-apple-darwin
            arch: aarch64
            os: darwin
            runner: macos-14  # Apple Silicon runner
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Protoc
        uses: arduino/setup-protoc@v3

      - name: Download proto file
        run: |
          mkdir -p src/build/proto
          curl -L -o src/build/proto/provider.proto \
            https://raw.githubusercontent.com/konveyor/analyzer-lsp/refs/heads/main/provider/internal/grpc/library.proto

      - name: Cache cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build
        run: |
          cargo build --release --target ${{ matrix.target }}
          strip target/${{ matrix.target }}/release/${{ env.BINARY_NAME }} || true

      - name: Create archive
        run: |
          cd target/${{ matrix.target }}/release
          tar czf ../../../c-sharp-analyzer-provider-${{ matrix.os }}-${{ matrix.arch }}.tar.gz ${{ env.BINARY_NAME }}
          cd ../../../
          shasum -a 256 c-sharp-analyzer-provider-${{ matrix.os }}-${{ matrix.arch }}.tar.gz > c-sharp-analyzer-provider-${{ matrix.os }}-${{ matrix.arch }}.tar.gz.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: c-sharp-analyzer-provider-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            c-sharp-analyzer-provider-${{ matrix.os }}-${{ matrix.arch }}.tar.gz
            c-sharp-analyzer-provider-${{ matrix.os }}-${{ matrix.arch }}.tar.gz.sha256

  # Build binaries for Windows targets
  build-windows:
    name: Build Windows ${{ matrix.target }}
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - target: x86_64-pc-windows-msvc
            arch: x86_64
            os: windows
          - target: aarch64-pc-windows-msvc
            arch: aarch64
            os: windows
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Protoc
        uses: arduino/setup-protoc@v3

      - name: Download proto file
        shell: bash
        run: |
          mkdir -p src/build/proto
          curl -L -o src/build/proto/provider.proto \
            https://raw.githubusercontent.com/konveyor/analyzer-lsp/refs/heads/main/provider/internal/grpc/library.proto

      - name: Cache cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build
        run: |
          cargo build --release --target ${{ matrix.target }}

      - name: Create archive
        shell: pwsh
        run: |
          $binary = "target/${{ matrix.target }}/release/${{ env.BINARY_NAME }}.exe"
          $archive = "c-sharp-analyzer-provider-${{ matrix.os }}-${{ matrix.arch }}.zip"
          Compress-Archive -Path $binary -DestinationPath $archive
          $hash = Get-FileHash -Path $archive -Algorithm SHA256
          "$($hash.Hash.ToLower())  $archive" | Out-File -FilePath "$archive.sha256" -Encoding ASCII

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: c-sharp-analyzer-provider-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            c-sharp-analyzer-provider-${{ matrix.os }}-${{ matrix.arch }}.zip
            c-sharp-analyzer-provider-${{ matrix.os }}-${{ matrix.arch }}.zip.sha256

  # Create GitHub release with all artifacts
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-linux, build-macos, build-windows]
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create checksums file
        run: |
          cd artifacts
          cat */*.sha256 > ../checksums.txt
          cd ..
          echo "Checksums:"
          cat checksums.txt

      - name: Determine tag name
        id: tag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "tag_name=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: Release ${{ steps.tag.outputs.tag_name }}
          draft: false
          prerelease: ${{ contains(steps.tag.outputs.tag_name, '-') }}
          files: |
            artifacts/*/*.tar.gz
            artifacts/*/*.zip
            checksums.txt
          body: |
            ## C# Analyzer Provider ${{ steps.tag.outputs.tag_name }}

            ### Installation

            Download the appropriate binary for your platform:

            #### Linux
            - `c-sharp-analyzer-provider-linux-x86_64.tar.gz` - Linux x86_64 (AMD64)
            - `c-sharp-analyzer-provider-linux-aarch64.tar.gz` - Linux ARM64

            #### macOS
            - `c-sharp-analyzer-provider-darwin-x86_64.tar.gz` - macOS Intel
            - `c-sharp-analyzer-provider-darwin-aarch64.tar.gz` - macOS Apple Silicon (M1/M2)

            #### Windows
            - `c-sharp-analyzer-provider-windows-x86_64.zip` - Windows x86_64 (AMD64)
            - `c-sharp-analyzer-provider-windows-aarch64.zip` - Windows ARM64

            ### Verification

            All binaries include SHA256 checksums. Verify your download:

            ```bash
            # Linux/macOS
            sha256sum -c c-sharp-analyzer-provider-<platform>.tar.gz.sha256

            # Windows (PowerShell)
            Get-FileHash c-sharp-analyzer-provider-<platform>.zip -Algorithm SHA256
            ```

            ### Usage

            ```bash
            # Extract (Linux/macOS)
            tar xzf c-sharp-analyzer-provider-<platform>.tar.gz

            # Extract (Windows)
            # Use Windows Explorer or PowerShell Expand-Archive

            # Run
            ./c-sharp-analyzer-provider-cli --port 9000 --name c-sharp
            ```

            ### Changes

            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ steps.tag.outputs.tag_name }}/CHANGELOG.md) for details.

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
